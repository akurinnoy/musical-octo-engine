schemaVersion: 2.2.0
metadata:
  name: bitnet-chat-che

components:
  # Компонент-контейнер, що визначає середовище виконання
  - name: bitnet-runtime
    container:
      # Eclipse Che автоматично збере цей Dockerfile з репозиторію
      image: '${CHE_DOCKERFILE_PATH}'
      memoryLimit: 8Gi
      cpuLimit: "4"
      mountSources: true
      endpoints:
        - name: bitnet-api
          targetPort: 8000
          exposure: internal

commands:
  # 1. Команда для ініціалізації git-підмодулів
  - id: init-submodules
    exec:
      component: bitnet-runtime
      commandLine: "git submodule update --init --recursive"
      workingDir: ${PROJECTS_ROOT}

  # 2. Команда для створення віртуального середовища Python
  - id: create-venv
    exec:
      component: bitnet-runtime
      commandLine: "python3 -m venv.venv"
      workingDir: ${PROJECTS_ROOT}

  # 3. Команда для встановлення залежностей Python
  - id: install-deps
    exec:
      component: bitnet-runtime
      commandLine: ".venv/bin/pip install -r api/requirements.txt"
      workingDir: ${PROJECTS_ROOT}

  # 4. Команда для завантаження моделі
  - id: download-model
    exec:
      component: bitnet-runtime
      commandLine: "bash scripts/download_model.sh"
      workingDir: ${PROJECTS_ROOT}

  # 5. Команда для компіляції рушія bitnet.cpp
  - id: build-bitnet
    exec:
      component: bitnet-runtime
      commandLine: "bash scripts/build.sh"
      workingDir: ${PROJECTS_ROOT}

  # Композитна команда для повної підготовки середовища
  - id: prepare-environment
    composite:
      label: "1. Prepare Environment"
      commands:
        - init-submodules
        - create-venv
        - install-deps
        - download-model
        - build-bitnet
      group:
        kind: build
        isDefault: true

  # Команда для запуску API-сервера
  - id: run-api-server
    exec:
      component: bitnet-runtime
      label: "2. Run API Server"
      commandLine: ".venv/bin/uvicorn api.main:app --host 0.0.0.0 --port 8000"
      workingDir: ${PROJECTS_ROOT}
      group:
        kind: run
        isDefault: true
