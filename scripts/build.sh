#!/bin/bash

# Скрипт для компіляції C++ рушія bitnet.cpp

set -e # Зупинити виконання при першій помилці

# Визначення шляху до директорії BitNet
BITNET_DIR="${PROJECT_SOURCE}/BitNet"
# Визначення типу квантизації. 'i2_s' є поширеним значенням за замовчуванням.
QUANT_TYPE="i2_s"

echo "Початок процесу компіляції bitnet.cpp..."

# Перевірка, чи існує директорія BitNet
if [ ! -d $BITNET_DIR ]; then
    echo "Помилка: Директорія '$BITNET_DIR' не знайдена. Переконайтеся, що репозиторій було клоновано."
    exit 1
fi

# Перехід до директорії з вихідним кодом BitNet
cd "$BITNET_DIR"

# Створення директорії для збірки, якщо вона не існує
mkdir -p build
cd build

# Конфігурація проєкту за допомогою CMake
# Явно вказуємо компілятори та тип квантизації, необхідний для генерації коду
echo "Конфігурація збірки за допомогою CMake (тип квантизації: ${QUANT_TYPE})..."
cmake -DQUANT_TYPE=${QUANT_TYPE} -DCMAKE_C_COMPILER=clang-18 -DCMAKE_CXX_COMPILER=clang++-18 ..

# Компіляція проєкту
# Використовуємо `nproc` для визначення кількості ядер і паралельної збірки
echo "Компіляція bitnet.cpp (це може зайняти деякий час)..."
make -j$(nproc)

echo "Компіляція bitnet.cpp завершена успішно."
